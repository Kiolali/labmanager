<Module>
 <ModulePrefs title="Widget {{ widget_name }} of {{ lab_name }}">
     {% if public_rlms %}
         <Locale messages="{{ url_for('.public_rlms_translations', rlms_identifier = rlms_identifier, lab_name = lab_name, lang='en', _external = True) }}"/>
         <Locale lang="en" messages="{{ url_for('.public_rlms_translations', rlms_identifier = rlms_identifier, lab_name = lab_name, lang='en', _external = True) }}"/>
         {% for lang in widget_config['translations'].get('translations', {}) %}
            {% if lang != "en" %}
                <Locale lang="{{ lang }}" messages="{{ url_for('.public_rlms_translations', rlms_identifier = rlms_identifier, lab_name = lab_name, lang=lang, _external = True) }}"/>
            {% endif %}
         {% endfor %}
     {% elif public_lab %}
         <Locale messages="{{ url_for('.public_translations', lab_name = lab_name, _external = True, lang = 'en') }}"/>
         <Locale lang="en" messages="{{ url_for('.public_translations', lab_name = lab_name, _external = True, lang = 'en') }}"/>
         {% for lang in widget_config['translations'].get('translations', {}) %}
            {% if lang != "en" %}
                <Locale lang="{{ lang }}" messages="{{ url_for('.public_translations', lab_name = lab_name, _external = True, lang = lang) }}"/>
            {% endif %}
         {% endfor %}
     {% else %}
         <Locale messages="{{ url_for('.translations', institution_id = institution_id, lab_name = lab_name, _external = True, lang = 'en') }}"/>
         <Locale lang="en" messages="{{ url_for('.translations', institution_id = institution_id, lab_name = lab_name, _external = True, lang = 'en') }}"/>
         {% for lang in widget_config['translations'].get('translations', {}) %}
            {% if lang != "en" %}
                <Locale lang="{{ lang }}" messages="{{ url_for('.translations', institution_id = institution_id, lab_name = lab_name, _external = True, lang = lang) }}"/>
            {% endif %}
         {% endfor %}
     {% endif %}
     <Require feature="osapi" />
     <Require feature="pubsub" />
     <Require feature="dynamic-height" />
 </ModulePrefs>
 <Content type="html" view="home,canvas">
 <![CDATA[
    <link  href="{{ url_for('static', filename="bootstrap/css/bootstrap.css", _external = True) }}" rel="stylesheet">

    <script type="text/javascript" src="{{ url_for('static', filename='jquery-1.8.3.min.js', _external = True) }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='iframeResizer.min.js', _external = True) }}"></script>
    <script type="text/javascript" src="http://shindig2.epfl.ch/ils/main/ils_graaspeu.js"></script>
    <script type="text/javascript" src="http://open-app.googlecode.com/files/openapp.js"></script>
{% if public_rlms %}
    <script type="text/javascript" src="{{ url_for('.public_rlms_smartgateway', rlms_identifier = rlms_identifier, lab_name = lab_name, _external = True, lab_config = request.args.get('lab_config')) }}"></script>
{% elif public_lab %}
    <script type="text/javascript" src="{{ url_for('.public_smartgateway', lab_name = lab_name, _external = True, lab_config = request.args.get('lab_config')) }}"></script>
{% else %}
    <script type="text/javascript" src="{{ url_for('.smartgateway', institution_id = institution_id, lab_name = lab_name, _external = True, lab_config = request.args.get('lab_config')) }}"></script>
{% endif %}



<script type="text/javaScript">
    
    var sg;

    function adjustIframeHeight() {
//        $("#final_widget_iframe").removeAttr("height");
        gadgets.window.adjustHeight();
    }

    function init() {
        var prefs = new gadgets.Prefs();
        var localeString = "";
        if (prefs.getLang() != undefined && prefs.getLang() != null && prefs.getCountry() != undefined && prefs.getCountry() != null) {
            if (prefs.getLang().length > 0 && prefs.getCountry().length > 0) {
                localeString = "&locale=" + prefs.getLang() + "_" + prefs.getCountry();
            }
        }
        // Create SmartGateway
        trace("Initializing SmartGateway...");
        sg = new SmartGateway($('#container'), $('#buttondiv'), $('#reserve_button'));
        trace("SmartGateway initialized.");
        // Register a callback: whenever a widget has a reservationId, this method is called 
        sg.registerOnLoad( function(reservationId) {
            
            {% if public_rlms %}
            var url = '{{ url_for(".open_public_rlms_widget", rlms_identifier = rlms_identifier, lab_name = lab_name, widget_name = widget_name, _external = True) }}?reservation_id=' + reservationId + localeString;
            {% elif public_lab %}
            var url = '{{ url_for(".open_public_widget", lab_name = lab_name, widget_name = widget_name, _external = True) }}?reservation_id=' + reservationId + localeString;
            {% else %}
            var url = '{{ url_for(".open_widget", institution_id = institution_id, lab_name = lab_name, widget_name = widget_name, _external = True) }}?reservation_id=' + reservationId + localeString;
            {% endif %}

            $("#container").html("");
            // Now show it
            var contents = $("<iframe frameborder='no' id='final_widget_iframe' src='" + url + "' height='{% if 'height' in widget_config %}{{ widget_config['height'] }}{% else %}500px{% endif %}' width='98.9%'>");
            trace("I'm going to set as innerHTML: ");
            trace(contents);
            $("#container").append(contents); 
            gadgets.window.adjustHeight();

            // We set three timeouts to make sure the apps are loaded to do proper resizing
            // if it take long time, it will be resized when mouse is moved above the app
            // setTimeout(adjustIframeHeight,1000);
            // 3 seconds
            setTimeout(adjustIframeHeight,3000);
            // 10 seconds
            setTimeout(adjustIframeHeight,10000);

            iFrameResize({
                log : false,
                enablePublicMethods : true,
                enableInPageLinks : true,
                checkOrigin: false,
                resizedCallback         : function(messageData){ // Callback fn when resize is received
                    gadgets.window.adjustHeight();
                }
            }, "#final_widget_iframe");
        });
        trace("Callback registered.");
        {% if autoload %}
        sg.startReservation();
        {% endif %}
    }

    trace("Registering...");
    gadgets.util.registerOnLoadHandler(init);
    trace("Registered.");
</script>

<div id="buttondiv" style="display: none">
    <div class="span8 offset1" style="border-radius: 25px; border: 2px solid #bbb; padding: 20px;">
        <div>
            <legend class="">Laboratory {{ lab_name }}</legend>
        </div>

        <table class="table table-striped table-bordered">
            <tbody>
                <tr>
                    <td>System</td>
                    <td><a target=_blank href="{{ rlms.url }}">{{ rlms.get_name() }}</a> </td>
                </tr>

                <tr>
                    <td>Location</td>
                    <td>{{ rlms.location }}</td>
                </tr>

            </tbody>
        </table>
        
        <div style="width: 100%; text-align: center">
            <button id='reserve_button' class='btn btn-primary'>Access the lab!</button>
            <br><br>
        </div>
        <hr>

        <div style="width: 100%; text-align: center">
            <a href="http://www.go-lab-project.eu/" target="_blank"><img height="120" src="{{ url_for('static', filename='golab.png') }}" alt="Go-Lab logo" /></a>
            <h5>Smart Gateway</h5>
        </div>
    </div>
</div>
<div id="container" style="text-align: center">Loading...</div>
 ]]>
</Content>
</Module>
